<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>G√©n√©rateur Code Carnot - Centre L√©on B√©rard</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    *{margin:0;padding:0;box-sizing:border-box;}
    :root{
      --clb-rose:#c4165a;--clb-rose-light:#d63d73;--clb-blue:#003d82;
      --clb-blue-light:#0066cc;--clb-blue-pale:#e8f0ff;
      --clb-border:#e0e0e0;--clb-dark:#2c2c2c;
      --clb-success:#27ae60;--clb-error:#c0392b;
    }
    body{
      font-family:'Inter',sans-serif;background:#fff;color:var(--clb-dark);
    }
    .navbar{
      position:fixed;top:0;left:0;right:0;background:#fff;
      border-bottom:1px solid var(--clb-border);z-index:1000;
    }
    .navbar-container{
      max-width:1100px;margin:auto;padding:12px 20px;
      display:flex;align-items:center;gap:14px;
    }
    .navbar-logo img{height:48px;width:auto;}
    .navbar-title{font-size:18px;font-weight:800;color:var(--clb-blue);}
    .container{max-width:800px;margin:100px auto 40px;padding:0 20px;}
    .card{
      background:#fff;border:1px solid var(--clb-border);
      border-radius:12px;padding:28px;
    }
    h1{
      font-size:30px;font-weight:800;
      background:linear-gradient(135deg,var(--clb-blue),var(--clb-rose));
      -webkit-background-clip:text;-webkit-text-fill-color:transparent;
      margin-bottom:6px;text-align:center;
    }
    .subtitle{text-align:center;color:#666;font-size:14px;margin-bottom:16px;}
    .section-header{
      margin:20px 0 12px;font-weight:800;color:var(--clb-blue);
      border-bottom:2px solid var(--clb-rose);padding-bottom:8px;
      display:flex;gap:8px;align-items:center;
    }
    .form-group{margin-bottom:18px;}
    label{font-weight:700;font-size:14px;margin-bottom:6px;display:block;}
    input,select,textarea{
      width:100%;padding:12px 14px;border:1.5px solid var(--clb-border);
      border-radius:8px;font-family:inherit;font-size:14px;
    }
    select{
      appearance:none;
      background:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12'%3E%3Cpath fill='%23c4165a' d='M6 9L1 4h10z'/%3E%3C/svg%3E")
      no-repeat right 14px center;
    }
    textarea{min-height:100px;resize:vertical;}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px;}
    .checkbox-group{
      display:flex;align-items:center;gap:10px;
      background:var(--clb-blue-pale);padding:12px;border-radius:8px;
    }
    button{
      width:100%;padding:14px;margin:14px 0;
      background:linear-gradient(135deg,var(--clb-rose),var(--clb-rose-light));
      color:#fff;border:none;border-radius:8px;font-weight:800;
      cursor:pointer;
    }
    .alert{display:none;padding:14px;border-left:4px solid;margin-bottom:12px;}
    .alert-success{background:#f0fdf4;color:var(--clb-success);border-color:var(--clb-success);}
    .code-box{
      display:none;margin-top:20px;padding:20px;border:2px solid var(--clb-rose);
      border-radius:12px;text-align:center;
    }
    .code{font-size:36px;font-weight:900;color:var(--clb-rose);}

    /* Actions sous le code */
    .mini-actions{
      display:flex;
      justify-content:center;
      gap:10px;
      flex-wrap:wrap;
      margin-top:14px;
    }
    .mini-btn{
      width:auto;
      padding:10px 14px;
      margin:0;
      border-radius:8px;
      font-size:13px;
      font-weight:800;
      cursor:pointer;
    }
    .mini-btn.secondary{
      background:linear-gradient(135deg,var(--clb-blue),var(--clb-blue-light));
    }

    .footer{
      margin-top:60px;padding:24px;text-align:center;
      font-size:12px;color:#999;border-top:2px solid var(--clb-rose);
      background:#f5f5f5;
    }
    @media(max-width:768px){
      .grid-2{grid-template-columns:1fr;}
    }
  </style>
</head>

<body>

<nav class="navbar">
  <div class="navbar-container">
    <div class="navbar-logo">
      <img src="./Logo-centre-leon-berard-lyon.png" alt="CLB">
    </div>
    <div class="navbar-title">G√©n√©rateur Code Carnot</div>
  </div>
</nav>

<div class="container">
  <div class="card">

    <h1>Formulaire Carnot</h1>
    <p class="subtitle">Le code Carnot est g√©n√©r√© automatiquement √† partir des √©l√©ments saisis</p>

    <!-- BOUTON EN HAUT -->
    <button type="submit" form="carnotForm">‚úì G√©n√©rer Code Carnot</button>

    <div id="formSuccess" class="alert alert-success"></div>

    <form id="carnotForm">

      <div class="section-header">üìù Informations Projet</div>

      <div class="grid-2">
        <div class="form-group">
          <label>R√©f√©rence Interne</label>
          <input type="text" id="formRef">
        </div>
        <div class="form-group">
          <label>Intitul√© Projet</label>
          <input type="text" id="formIntitule">
        </div>
      </div>

      <div class="section-header">üè∑Ô∏è Classification</div>

      <!-- A -->
      <label>√âquipe Juridique (A)</label>
      <select id="formA" required>
        <option value="" selected disabled>S√©lectionner‚Ä¶</option>
        <option value="1">Juridique H√¥pital CLB</option>
        <option value="2">Juridique DRCI CLB</option>
        <option value="3">Valo / Juridique recherche</option>
        <option value="4">LIP / EZUS / UCBL</option>
        <option value="5">CNRS</option>
        <option value="6">INSERM</option>
      </select>

      <!-- B -->
      <label>Type de Contrat (B)</label>
      <select id="formB" required>
        <option value="" selected disabled>S√©lectionner‚Ä¶</option>
        <option value="1">MTA / DTA</option>
        <option value="2">Collaboration</option>
        <option value="3">Prestation</option>
        <option value="4">Contrat de financement / reversement</option>
        <option value="5">Clinique Phase I (ou I + II)</option>
        <option value="6">Clinique Phase II</option>
        <option value="7">Clinique Phase III</option>
        <option value="8">Collab Etude Ancillaire</option>
        <option value="9">H√©bergement</option>
      </select>

      <!-- C -->
      <label>Pilotage Projet (C)</label>
      <select id="formC" required>
        <option value="" selected disabled>S√©lectionner‚Ä¶</option>
        <option value="1">DRCI promotion CLB Pr√©coces</option>
        <option value="2">DRCI Investigation Indus</option>
        <option value="3">DRCI Investigation CLB</option>
        <option value="4">Cellule projets / grant</option>
        <option value="5">EMS</option>
        <option value="6">√âquipe de recherche</option>
        <option value="7">DSI</option>
        <option value="8">Plateformes technologiques</option>
        <option value="9">√âquipe H√¥pital</option>
        <option value="0">Pilotage cotutelle</option>
      </select>

      <!-- D -->
      <label>Financeur (D)</label>
      <select id="formD" required>
        <option value="" selected disabled>S√©lectionner‚Ä¶</option>
        <option value="1">Acad√©mique / Public</option>
        <option value="2">Association / Fondation</option>
        <option value="3">Fondation industrielle</option>
        <option value="4">Industrie Pharma / Biotech</option>
        <option value="5">Industrie Dispositif M√©dical</option>
        <option value="6">Industrie Data / IT</option>
        <option value="7">√âquipement recherche</option>
        <option value="8">CRO</option>
        <option value="9">Priv√© autre</option>
      </select>

      <!-- E -->
      <label>Propri√©t√© (E)</label>
      <select id="formE" required>
        <option value="" selected disabled>S√©lectionner‚Ä¶</option>
        <option value="1">CLB propri√©taire donn√©es et r√©sultats</option>
        <option value="2">CLB propri√©taire donn√©es</option>
        <option value="3">CLB propri√©taire r√©sultats</option>
        <option value="4">Publication uniquement</option>
        <option value="5">Am√©lioration savoir-faire CLB</option>
        <option value="6">Aucune valorisation CLB</option>
      </select>

      <div class="section-header">üí∞ Montant</div>

      <input type="number" id="formMontant" value="0" required>

      <div class="checkbox-group">
        <input type="checkbox" id="formPME">
        <label for="formPME">PME</label>
      </div>

    </form>

    <div id="codeBox" class="code-box">
      <h3>Code Carnot</h3>
      <div class="code" id="generatedCode"></div>

      <div class="mini-actions">
        <button type="button" class="mini-btn secondary" id="copyBtn">üìã Copier</button>
        <button type="button" class="mini-btn secondary" id="pdfBtn">üìÑ Exporter PDF</button>
      </div>
    </div>

  </div>
</div>

<div class="footer">
  <p><strong>Centre L√©on B√©rard ‚Äî G√©n√©rateur Code Carnot</strong></p>
  <p>Contact : <a href="mailto:beyram.frigui@lyon.unicancer.fr">beyram.frigui@lyon.unicancer.fr</a></p>
</div>

<script>
  function calculateF(m,p){
    if(m<0)return 6;
    if(m===0)return 5;
    if(m<15000)return 1;
    if(m<=30000)return p?2:3;
    return 4;
  }

  document.getElementById("carnotForm").addEventListener("submit",e=>{
    e.preventDefault();

    const a = formA.value, b = formB.value, c = formC.value, d = formD.value, e1 = formE.value;
    const m = parseFloat(formMontant.value || 0), p = formPME.checked;

    const code = `CT ${a}${b}${c}${d}${e1}${calculateF(m,p)}`;

    generatedCode.textContent = code;
    codeBox.style.display = "block";
    formSuccess.style.display = "block";
    formSuccess.innerHTML = `‚úÖ Code g√©n√©r√© : <strong>${code}</strong>`;
  });

  // Copier
  document.getElementById('copyBtn').addEventListener('click', async () => {
    const code = document.getElementById('generatedCode').textContent.trim();
    if (!code) return;

    try {
      await navigator.clipboard.writeText(code);
      formSuccess.style.display = "block";
      formSuccess.innerHTML = `‚úÖ Code copi√© : <strong>${code}</strong>`;
    } catch (e) {
      formSuccess.style.display = "block";
      formSuccess.innerHTML = `‚ö†Ô∏è Copie impossible automatiquement. S√©lectionne le code et copie-le.`;
    }
  });

  // Exporter PDF (fiche propre + impression => enregistrer en PDF)
  document.getElementById('pdfBtn').addEventListener('click', () => {
    const code = document.getElementById('generatedCode').textContent.trim();
    if (!code) return;

    const ref = (document.getElementById('formRef')?.value || '').trim();
    const intitule = (document.getElementById('formIntitule')?.value || '').trim();
    const montant = (document.getElementById('formMontant')?.value || '').trim();
    const pme = document.getElementById('formPME')?.checked ? 'Oui' : 'Non';

    const textA = document.getElementById('formA').selectedOptions[0]?.textContent || '';
    const textB = document.getElementById('formB').selectedOptions[0]?.textContent || '';
    const textC = document.getElementById('formC').selectedOptions[0]?.textContent || '';
    const textD = document.getElementById('formD').selectedOptions[0]?.textContent || '';
    const textE = document.getElementById('formE').selectedOptions[0]?.textContent || '';

    const dateExport = new Date().toLocaleDateString('fr-FR');
    const logoSrc = "./Logo-centre-leon-berard-lyon.png";

    const safe = (s) => (s || '').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');

    const html = `
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Export Code Carnot</title>
  <style>
    @page { margin: 18mm; }
    body { font-family: Arial, sans-serif; color:#222; }
    .header { display:flex; align-items:center; gap:14px; border-bottom:2px solid #c4165a; padding-bottom:10px; margin-bottom:18px; }
    .header img { height:42px; width:auto; }
    .title { font-size:16px; font-weight:700; }
    .sub { font-size:12px; color:#666; margin-top:2px; }
    .card { border:1px solid #e0e0e0; border-radius:10px; padding:14px; margin-bottom:14px; }
    .label { font-size:11px; color:#666; text-transform:uppercase; letter-spacing:.3px; margin-bottom:6px; }
    .bigcode { font-size:28px; font-weight:800; color:#c4165a; letter-spacing:1px; }
    table { width:100%; border-collapse:collapse; }
    td { padding:8px 10px; border-bottom:1px solid #eee; font-size:12px; vertical-align:top; }
    td.k { width:34%; color:#003d82; font-weight:700; }
    .footer { margin-top:18px; font-size:10px; color:#777; }
  </style>
</head>
<body>
  <div class="header">
    <img src="${logoSrc}" alt="CLB">
    <div>
      <div class="title">Centre L√©on B√©rard ‚Äî G√©n√©rateur Code Carnot</div>
      <div class="sub">Export du ${safe(dateExport)}</div>
    </div>
  </div>

  <div class="card">
    <div class="label">Code Carnot</div>
    <div class="bigcode">${safe(code)}</div>
  </div>

  <div class="card">
    <div class="label">Informations projet</div>
    <table>
      <tr><td class="k">R√©f√©rence interne</td><td>${safe(ref || '-')}</td></tr>
      <tr><td class="k">Intitul√©</td><td>${safe(intitule || '-')}</td></tr>
      <tr><td class="k">Montant (‚Ç¨)</td><td>${safe(montant || '-')}</td></tr>
      <tr><td class="k">PME</td><td>${safe(pme)}</td></tr>
    </table>
  </div>

  <div class="card">
    <div class="label">Classification</div>
    <table>
      <tr><td class="k">A ‚Äî √âquipe juridique</td><td>${safe(textA || '-')}</td></tr>
      <tr><td class="k">B ‚Äî Type de contrat</td><td>${safe(textB || '-')}</td></tr>
      <tr><td class="k">C ‚Äî Pilotage</td><td>${safe(textC || '-')}</td></tr>
      <tr><td class="k">D ‚Äî Financeur</td><td>${safe(textD || '-')}</td></tr>
      <tr><td class="k">E ‚Äî Propri√©t√©</td><td>${safe(textE || '-')}</td></tr>
    </table>
  </div>

  <div class="footer">
    Pour toute question : beyram.frigui@lyon.unicancer.fr
  </div>

  <script>
    window.onload = () => window.print();
  </script>
</body>
</html>
`;

    const w = window.open('', '_blank');
    w.document.open();
    w.document.write(html);
    w.document.close();
  });
</script>

</body>
</html>
