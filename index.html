```html
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>G√©n√©rateur Code Carnot - Centre L√©on B√©rard</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    *{ margin:0; padding:0; box-sizing:border-box; }

    :root{
      --clb-rose:#c4165a;
      --clb-rose-light:#d63d73;
      --clb-rose-dark:#9a0d46;
      --clb-blue:#003d82;
      --clb-blue-light:#0066cc;
      --clb-blue-pale:#e8f0ff;
      --clb-gray:#f5f5f5;
      --clb-dark:#2c2c2c;
      --clb-border:#e0e0e0;
      --clb-success:#27ae60;
      --clb-error:#c0392b;
    }

    body{
      font-family:'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background:#fff;
      min-height:100vh;
      color:var(--clb-dark);
      line-height:1.6;
    }

    .navbar{
      position:fixed; top:0; left:0; right:0;
      background:#fff;
      border-bottom:1px solid var(--clb-border);
      box-shadow:0 2px 8px rgba(0,0,0,0.05);
      z-index:1000;
    }
    .navbar-container{
      max-width:1100px;
      margin:0 auto;
      padding:12px 20px;
      display:flex;
      align-items:center;
      gap:16px;
    }
    .navbar-logo img{ height:48px; width:auto; display:block; }
    .navbar-title{
      font-size:18px;
      font-weight:800;
      color:var(--clb-blue);
      letter-spacing:-0.4px;
      white-space:nowrap;
    }

    .container{
      max-width:800px;
      width:100%;
      margin:100px auto 40px;
      padding:0 20px;
    }

    .card{
      background:#fff;
      border-radius:12px;
      border:1px solid var(--clb-border);
      box-shadow:0 2px 12px rgba(0,0,0,0.06);
      padding:48px;
      transition: box-shadow .3s ease, border-color .3s ease;
    }
    .card:hover{
      box-shadow:0 4px 20px rgba(196,22,90,0.08);
      border-color:var(--clb-rose);
    }
    .card-header{
      margin-bottom:26px;
      text-align:center;
    }
    h1{
      font-size:32px;
      font-weight:800;
      background:linear-gradient(135deg, var(--clb-blue) 0%, var(--clb-rose) 100%);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      background-clip:text;
      margin-bottom:10px;
    }
    .subtitle{
      color:#666;
      font-size:14px;
      font-weight:400;
    }

    .form-group{ margin-bottom:28px; }
    .form-group label{
      display:block;
      margin-bottom:10px;
      font-weight:700;
      color:var(--clb-dark);
      font-size:14px;
    }

    .form-group.required > label::after{
      content:" *";
      color:#e11d48;
      font-weight:900;
    }

    input[type="text"],
    input[type="number"],
    input[type="date"],
    select,
    textarea{
      width:100%;
      padding:13px 16px;
      border:1.5px solid var(--clb-border);
      border-radius:8px;
      font-size:14px;
      font-family:'Inter', inherit;
      background:#fff;
      transition:border-color .3s ease, box-shadow .3s ease;
    }
    input:focus, select:focus, textarea:focus{
      outline:none;
      border-color:var(--clb-rose);
      box-shadow:0 0 0 4px rgba(196,22,90,0.08);
    }

    select{
      cursor:pointer;
      appearance:none;
      padding-right:40px;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23c4165a' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
      background-repeat:no-repeat;
      background-position:right 16px center;
    }

    textarea{ resize:vertical; min-height:110px; }

    .grid-2{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:22px;
    }
    .grid-2 > *{ min-width:0; }

    .checkbox-group{
      display:flex;
      align-items:center;
      gap:12px;
      padding:14px 16px;
      background:var(--clb-blue-pale);
      border-radius:8px;
      border:1.5px solid var(--clb-blue-light);
      height:48px;
      width:100%;
      box-sizing:border-box;
    }
    input[type="checkbox"]{
      width:18px;
      height:18px;
      cursor:pointer;
      accent-color:var(--clb-rose);
    }

    .section-header{
      font-size:16px;
      font-weight:800;
      color:var(--clb-blue);
      margin-top:32px;
      margin-bottom:18px;
      padding-bottom:12px;
      border-bottom:2px solid var(--clb-rose);
      display:flex;
      align-items:center;
      gap:10px;
    }

    button{
      width:100%;
      padding:14px 28px;
      background:linear-gradient(135deg, var(--clb-rose) 0%, var(--clb-rose-light) 100%);
      color:#fff;
      border:none;
      border-radius:8px;
      font-size:15px;
      font-weight:800;
      cursor:pointer;
      transition:all .3s ease;
      box-shadow:0 4px 12px rgba(196,22,90,0.25);
    }
    button:hover:not(:disabled){
      transform:translateY(-2px);
      box-shadow:0 6px 20px rgba(196,22,90,0.35);
    }

    .alert{
      padding:16px 20px;
      border-radius:8px;
      margin-bottom:18px;
      font-size:14px;
      border-left:4px solid;
      display:none;
    }
    .alert-success{
      background:#f0fdf4;
      color:var(--clb-success);
      border-left-color:var(--clb-success);
    }
    .alert-error{
      background:#fef0f2;
      color:var(--clb-error);
      border-left-color:var(--clb-error);
    }

    .code-box{
      background:linear-gradient(135deg, var(--clb-blue-pale) 0%, #f0f8ff 100%);
      border:2px solid var(--clb-rose);
      padding:26px;
      border-radius:12px;
      text-align:center;
      margin-top:18px;
      display:none;
    }
    .code-box h3{
      color:var(--clb-blue);
      margin-bottom:12px;
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:1.2px;
      font-weight:800;
    }
    .code-box .code{
      font-size:40px;
      font-weight:900;
      color:var(--clb-rose);
      font-family:'Monaco','Courier New', monospace;
      letter-spacing:2px;
    }
    .mini-actions{
      display:flex;
      gap:10px;
      margin-top:14px;
      justify-content:center;
      flex-wrap:wrap;
    }
    .mini-btn{
      width:auto;
      padding:10px 14px;
      font-size:13px;
      border-radius:8px;
      font-weight:800;
      box-shadow:none;
      margin:0;
    }
    .mini-btn.secondary{
      background:linear-gradient(135deg, var(--clb-blue) 0%, var(--clb-blue-light) 100%);
    }
    .mini-btn.danger{
      background:linear-gradient(135deg, #9a0d46 0%, #c0392b 100%);
    }
    .mini-btn.ghost{
      background:linear-gradient(135deg, #6b7280 0%, #9ca3af 100%);
    }

    .decomp-box{
      margin-top:16px;
      text-align:left;
      background:#fff;
      border:1px dashed var(--clb-border);
      border-radius:10px;
      padding:14px 16px;
      display:none;
    }
    .decomp-title{
      font-weight:900;
      color:var(--clb-blue);
      margin-bottom:10px;
      font-size:13px;
      text-transform:uppercase;
      letter-spacing:0.6px;
    }
    .decomp-list{
      display:grid;
      grid-template-columns: 1fr;
      gap:8px;
      font-size:13px;
      color:#333;
    }
    .pill{
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      font-weight:900;
      background:var(--clb-blue-pale);
      border:1px solid var(--clb-blue-light);
      margin-right:8px;
    }

    .history{
      margin-top:22px;
      text-align:left;
      background:#fff;
      border:1px solid var(--clb-border);
      border-radius:12px;
      padding:16px;
      display:none;
    }
    .history-header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      margin-bottom:12px;
    }
    .history-title{
      font-weight:900;
      color:var(--clb-blue);
      white-space:nowrap;
    }
    .history-list{
      display:flex;
      flex-direction:column;
      gap:10px;
      max-height:320px;
      overflow:auto;
      padding-right:6px;
    }
    .history-item{
      border:1px solid var(--clb-border);
      border-radius:10px;
      padding:12px;
      background:linear-gradient(135deg, #fff 0%, #fafafa 100%);
    }
    .history-top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .history-code{
      font-family:'Monaco','Courier New', monospace;
      font-weight:900;
      color:var(--clb-rose);
      letter-spacing:1px;
    }
    .history-meta{
      font-size:12px;
      color:#666;
      margin-top:6px;
      line-height:1.4;
    }
    .history-actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }

    .modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.35);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:2000;
    }
    .modal{
      width:min(720px, 100%);
      background:#fff;
      border:1px solid var(--clb-border);
      border-radius:14px;
      box-shadow:0 10px 30px rgba(0,0,0,0.18);
      padding:18px;
    }
    .modal h4{
      margin:0 0 10px 0;
      color:var(--clb-blue);
      font-weight:900;
    }
    .modal p{
      margin:0 0 12px 0;
      color:#555;
      font-size:13px;
    }
    .modal textarea{
      min-height:180px;
      font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:13px;
    }
    .modal-actions{
      display:flex;
      gap:10px;
      justify-content:flex-end;
      flex-wrap:wrap;
      margin-top:12px;
    }

    .print-only{ display:none; }
    @media print{
      .navbar, .container, .footer{ display:none !important; }
      .print-only{ display:block !important; }
    }

    .footer{
      margin-top:60px;
      padding:28px 20px;
      text-align:center;
      color:#999;
      font-size:12px;
      border-top:2px solid var(--clb-rose);
      background:var(--clb-gray);
    }

    @media (max-width:768px){
      .grid-2{ grid-template-columns:1fr; }
      .card{ padding:28px 18px; }
      h1{ font-size:26px; }
      .navbar-title{ font-size:16px; }
      .code-box .code{ font-size:34px; }
    }
  </style>

  <script async src="https://www.googletagmanager.com/gtag/js?id=G-3PCMW8QC2N"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-3PCMW8QC2N');
  </script>
</head>

<body>
  <nav class="navbar">
    <div class="navbar-container">
      <div class="navbar-logo">
        <img src="./Logo-centre-leon-berard-lyon.png" alt="CLB">
      </div>
      <div class="navbar-title">G√©n√©rateur Code Carnot</div>
    </div>
  </nav>

  <!-- PRINT -->
  <div class="print-only" style="padding:28px;">
    <h2 style="color:#003d82; margin-bottom:10px;">Centre L√©on B√©rard ‚Äî Code Carnot</h2>
    <div id="printBlock" style="border:1px solid #e0e0e0; border-radius:12px; padding:16px;"></div>
    <p style="margin-top:10px; color:#666; font-size:12px;">
      Imprim√© le <span id="printDate"></span>
    </p>
  </div>

  <div class="container">
    <div class="card">
      <div class="card-header">
        <h1>Formulaire Carnot</h1>
        <p class="subtitle">Le code Carnot est g√©n√©r√© automatiquement √† partir des √©l√©ments saisis</p>
      </div>

      <button type="submit" form="carnotForm" style="margin-top: 0; margin-bottom: 18px;">
        ‚úì G√©n√©rer Code Carnot
      </button>

      <div id="codeBox" class="code-box">
        <h3>Code Carnot G√©n√©r√©</h3>
        <div class="code" id="generatedCode"></div>

        <div class="mini-actions">
          <button type="button" class="mini-btn secondary" id="copyBtn">üìã Copier</button>
          <button type="button" class="mini-btn" id="newBtn">‚ûï Nouveau</button>
          <button type="button" class="mini-btn ghost" id="printBtn">üñ®Ô∏è Imprimer / PDF</button>
        </div>

        <div id="decompBox" class="decomp-box">
          <div class="decomp-title">D√©composition (A ‚Ä¢ B ‚Ä¢ C ‚Ä¢ D ‚Ä¢ E ‚Ä¢ F)</div>
          <div class="decomp-list" id="decompList"></div>
        </div>

        <div id="historyBox" class="history">
          <div class="history-header">
            <div class="history-title">Historique (tous les codes)</div>

            <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; width:100%;">
              <input
                type="text"
                id="historySearch"
                placeholder="Rechercher (code, ref, projet, A-F, montant...)"
                style="flex:1; min-width:240px;"
              />
              <div class="history-actions">
                <button type="button" class="mini-btn ghost" id="importBtn">üì• Import</button>
                <button type="button" class="mini-btn ghost" id="exportHistoryBtn">‚¨áÔ∏è Export TXT</button>
                <button type="button" class="mini-btn danger" id="clearHistoryBtn">üóëÔ∏è Tout effacer</button>
              </div>
            </div>
          </div>
          <div class="history-list" id="historyList"></div>
        </div>

        <!-- ‚úÖ STATS (5) -->
        <div id="statsBox" class="history">
          <div class="history-header" style="margin-bottom:10px;">
            <div class="history-title">Statistiques (bas√©es sur l‚Äôhistorique)</div>
            <div class="history-actions">
              <button type="button" class="mini-btn ghost" id="refreshStatsBtn">üîÑ Rafra√Æchir</button>
            </div>
          </div>
          <div id="statsContent" class="history-meta" style="font-size:13px; color:#333;"></div>
        </div>
      </div>

      <div id="formError" class="alert alert-error"></div>
      <div id="formSuccess" class="alert alert-success"></div>

      <form id="carnotForm">
        <div class="section-header"><span>üìù</span>Informations Projet</div>
        <div class="grid-2">
          <div class="form-group">
            <label>R√©f√©rence Interne</label>
            <input type="text" id="formRef">
          </div>
          <div class="form-group">
            <label>Intitul√© Projet</label>
            <input type="text" id="formIntitule">
          </div>
        </div>

        <div class="section-header"><span>üè∑Ô∏è</span>Classification (A, B, C, D, E)</div>
        <div class="grid-2">
          <div class="form-group">
            <label>√âquipe Juridique (A)</label>
            <select id="formA" required>
              <option value="" selected disabled>S√©lectionner‚Ä¶</option>
              <option value="1">Juridique H√¥pital CLB</option>
              <option value="2">Juridique DRCI CLB</option>
              <option value="3">Valo / Juridique recherche</option>
              <option value="4">LIP / EZUS / UCBL</option>
              <option value="5">CNRS</option>
              <option value="6">INSERM</option>
            </select>
          </div>

          <div class="form-group">
            <label>Type de Contrat (B)</label>
            <select id="formB" required>
              <option value="" selected disabled>S√©lectionner‚Ä¶</option>
              <option value="1">MTA / DTA</option>
              <option value="2">Collaboration</option>
              <option value="3">Prestation</option>
              <option value="4">Contrat de financement / reversement</option>
              <option value="5">Clinique Phase I (ou I + II)</option>
              <option value="6">Clinique Phase II</option>
              <option value="7">Clinique Phase III</option>
              <option value="8">Clinique observationnelle - Collab Etude Ancillaire</option>
              <option value="9">H√©bergement</option>
            </select>
          </div>
        </div>

        <div class="grid-2">
          <div class="form-group">
            <label>Pilotage Projet (C)</label>
            <select id="formC" required>
              <option value="" selected disabled>S√©lectionner‚Ä¶</option>
              <option value="1">DRCI promotion CLB Pr√©coces</option>
              <option value="2">DRCI Investigation (Promotion Indus) - BEC</option>
              <option value="3">DRCI Promotion CLB non pr√©coce</option>
              <option value="4">Cellule projets / grant CLB</option>
              <option value="5">EMS</option>
              <option value="6">Equipe de recherche Translationnelle / Fondamentale / SHS</option>
              <option value="7">DSID</option>
              <option value="8">Plateformes technologiques (1 seule)</option>
              <option value="9">Equipe H√¥pital</option>
              <option value="0">Pilotage cotutelle (UCBL /Inserrm / CNRS / LIP /Ezus)</option>
            </select>
          </div>

          <div class="form-group">
            <label>Financeur (D)</label>
            <select id="formD" required>
              <option value="" selected disabled>S√©lectionner‚Ä¶</option>
              <option value="1">Acad√©mique / Public (ANR/europe...)</option>
              <option value="2">Association / Fondation ind√©pendante</option>
              <option value="3">Fondation industrielle</option>
              <option value="4">Industrie-M√©dicament / Pharma / Biotech</option>
              <option value="5">Industrie-Dispositif M√©dical / Equipements / MedTech</option>
              <option value="6">Industrie-Data / Logiciels / IT</option>
              <option value="7">√âquipement recherche</option>
              <option value="8">CRO</option>
              <option value="9">Industriel / Priv√© autre</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label>Propri√©t√© (E)</label>
          <select id="formE" required>
            <option value="" selected disabled>S√©lectionner‚Ä¶</option>
            <option value="1">CLB propri√©taire ou copro donn√©es g√©n√©r√©es ET r√©sultats</option>
            <option value="2">CLB propri√©taire ou copro donn√©es mais pas r√©sultats</option>
            <option value="3">CLB propri√©taire ou copro r√©sultats mais pas donn√©es</option>
            <option value="4">Publication uniquement - CLB ni copropri√©taire r√©sultats ni copro donn√©es g√©n√©r√©es</option>
            <option value="5">CLB propri√©taire des am√©liorations de son savoir-faire / connaissances propres (avec ou sans publication)</option>
            <option value="6">Aucune valorisation par le CLB</option>
          </select>
        </div>

        <div class="section-header"><span>üí∞</span>Montant</div>
        <div class="grid-2">
          <div class="form-group">
            <label>Montant du Contrat (‚Ç¨)</label>
            <input type="number" id="formMontant" value="0" min="-999999999" step="0.01" required />
            <small style="display:block; margin-top:8px; color:#666; font-size:12px;">
              0 = sans √©change financier ‚Ä¢ montant n√©gatif = paiement par le CLB
            </small>
          </div>
          <div class="form-group">
            <label>&nbsp;</label>
            <div class="checkbox-group">
              <input type="checkbox" id="formPME">
              <label for="formPME" style="margin:0; font-weight:800; cursor:pointer;">PME</label>
            </div>
          </div>
        </div>
      </form>

    </div>
  </div>

  <div class="footer">
    <p><strong>Centre L√©on B√©rard ‚Äî G√©n√©rateur Code Carnot</strong></p>
    <p style="margin-top: 8px;">
      Pour toute question, contactez :
      <a href="mailto:beyram.frigui@lyon.unicancer.fr" style="color:#c4165a; font-weight:600; text-decoration:none;">
        beyram.frigui@lyon.unicancer.fr
      </a>
    </p>
    <p style="margin-top: 10px;">¬© 2024 - Tous droits r√©serv√©s.</p>
  </div>

  <!-- Import modal -->
  <div id="importBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="importTitle">
    <div class="modal">
      <h4 id="importTitle">Importer une liste</h4>
      <p>Colle une liste (1 entr√©e par ligne). Les doublons (m√™me code) seront regroup√©s automatiquement.</p>
      <textarea id="importText" placeholder="CT 123456
CT 111222
..."></textarea>
      <div class="modal-actions">
        <button type="button" class="mini-btn ghost" id="importCancel">Annuler</button>
        <button type="button" class="mini-btn secondary" id="importConfirm">Importer</button>
      </div>
    </div>
  </div>

  <script>
    function calculateF(montant, pme) {
      if (Number.isNaN(montant)) montant = 0;
      if (montant < 0) return 6;
      if (montant === 0) return 5;
      if (montant < 15000) return 1;
      if (montant <= 30000) return pme ? 2 : 3;
      return 4;
    }

    function labelF(f) {
      switch (f) {
        case 1: return "< 15 k‚Ç¨";
        case 2: return "15‚Äì30 k‚Ç¨ pay√© par PME";
        case 3: return "15‚Äì30 k‚Ç¨ hors PME";
        case 4: return "> 30 k‚Ç¨";
        case 5: return "0 ‚Äî Sans √©change financier";
        case 6: return "< 0 ‚Äî Paiement par le CLB";
        default: return "";
      }
    }

    function showError(msg) {
      const el = document.getElementById('formError');
      el.textContent = msg;
      el.style.display = 'block';
      document.getElementById('formSuccess').style.display = 'none';
    }

    function showSuccess(html) {
      const el = document.getElementById('formSuccess');
      el.innerHTML = html;
      el.style.display = 'block';
      document.getElementById('formError').style.display = 'none';
    }

    function markRequiredFields() {
      document.querySelectorAll('.form-group').forEach(g => {
        if (g.querySelector('input[required], select[required], textarea[required]')) {
          g.classList.add('required');
        }
      });
    }
    markRequiredFields();

    function getSelectValue(id) { return document.getElementById(id).value; }
    function getSelectLabel(id) {
      const s = document.getElementById(id);
      const opt = s.options[s.selectedIndex];
      return opt ? opt.textContent.trim() : "";
    }

    const STORAGE_KEY = "carnot_history_v2";

    function loadHistory() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr : [];
      } catch {
        return [];
      }
    }
    function saveHistory(items) { localStorage.setItem(STORAGE_KEY, JSON.stringify(items)); }

    function formatDateISO(d) {
      const pad = (n) => String(n).padStart(2, "0");
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }

    async function copyText(text) {
      try { await navigator.clipboard.writeText(text); return true; }
      catch { return false; }
    }

    function buildDedupeKey(entry) {
      return (entry.code || "").replace(/\s+/g, " ").trim().toUpperCase();
    }

    function addToHistory(entry) {
      const items = loadHistory();
      const key = buildDedupeKey(entry);
      const idx = items.findIndex(it => buildDedupeKey(it) === key);

      if (idx >= 0) {
        const existing = items[idx];
        existing.count = (existing.count || 1) + 1;
        existing.createdAt = entry.createdAt || existing.createdAt;
        existing.lastSeenAt = entry.createdAt || existing.lastSeenAt || existing.createdAt;

        const fields = ["formRef","formIntitule","montant","pme","a","b","c","d","e","f","aLabel","bLabel","cLabel","dLabel","eLabel"];
        fields.forEach(f => {
          if ((existing[f] === undefined || existing[f] === "" || existing[f] === null) && entry[f] !== undefined && entry[f] !== "") {
            existing[f] = entry[f];
          }
        });

        items.splice(idx, 1);
        items.unshift(existing);
      } else {
        entry.count = entry.count || 1;
        entry.pinned = !!entry.pinned;
        entry.lastSeenAt = entry.createdAt || formatDateISO(new Date());
        items.unshift(entry);
      }

      items.sort((x, y) => (y.pinned === x.pinned) ? 0 : (y.pinned ? 1 : -1));

      saveHistory(items);
      renderHistory();
      renderStats(); // ‚úÖ refresh stats automatically
    }

    function removeFromHistory(index) {
      const items = loadHistory();
      items.splice(index, 1);
      saveHistory(items);
      renderHistory();
      renderStats();
    }

    function clearHistory() {
      saveHistory([]);
      renderHistory();
      renderStats();
    }

    function normalizeSearch(s) {
      return (s || "")
        .toString()
        .toLowerCase()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .trim();
    }

    function matchSearch(item, q) {
      if (!q) return true;
      const hay = [
        item.code, item.formRef, item.formIntitule,
        item.a, item.b, item.c, item.d, item.e, item.f,
        item.aLabel, item.bLabel, item.cLabel, item.dLabel, item.eLabel,
        item.montant, item.pme ? "pme oui" : "pme non"
      ].join(" | ");
      return normalizeSearch(hay).includes(normalizeSearch(q));
    }

    function renderHistory() {
      const box = document.getElementById("historyBox");
      const list = document.getElementById("historyList");
      const items = loadHistory();
      const q = document.getElementById("historySearch") ? document.getElementById("historySearch").value : "";

      const filtered = items.filter(it => matchSearch(it, q));

      if (!items.length) {
        box.style.display = "none";
        list.innerHTML = "";
        return;
      }

      box.style.display = "block";

      if (!filtered.length) {
        list.innerHTML = `<div style="color:#666; font-size:13px; padding:10px;">Aucun r√©sultat pour ¬´ <strong>${q}</strong> ¬ª</div>`;
        return;
      }

      list.innerHTML = filtered.map((it) => {
        const idx = items.indexOf(it);
        const meta = [
          it.a !== undefined ? `A=${it.a} (${it.aLabel || ""})` : null,
          it.b !== undefined ? `B=${it.b} (${it.bLabel || ""})` : null,
          it.c !== undefined ? `C=${it.c} (${it.cLabel || ""})` : null,
          it.d !== undefined ? `D=${it.d} (${it.dLabel || ""})` : null,
          it.e !== undefined ? `E=${it.e} (${it.eLabel || ""})` : null,
          it.f !== undefined ? `F=${it.f} (${labelF(it.f)})` : null,
          it.montant !== undefined ? `Montant=${it.montant}` : null,
          it.pme !== undefined ? `PME=${it.pme ? "Oui" : "Non"}` : null,
          it.formRef ? `Ref=${it.formRef}` : null,
          it.formIntitule ? `Projet=${it.formIntitule}` : null,
        ].filter(Boolean).join(" ‚Ä¢ ");

        const badge = it.count && it.count > 1
          ? `<span style="font-size:12px; font-weight:900; background:#fff; border:1px solid #e0e0e0; padding:2px 8px; border-radius:999px;">√ó${it.count}</span>`
          : "";

        const pin = it.pinned ? "üìå" : "üìç";

        return `
          <div class="history-item">
            <div class="history-top">
              <div>
                <div class="history-code">${it.code} ${badge}</div>
                <div class="history-meta">${it.createdAt || ""}</div>
              </div>
              <div class="history-actions">
                <button type="button" class="mini-btn ghost" data-action="pin" data-idx="${idx}">${pin}</button>
                <button type="button" class="mini-btn secondary" data-action="copy" data-idx="${idx}">üìã Copier</button>
                <button type="button" class="mini-btn danger" data-action="delete" data-idx="${idx}">üóëÔ∏è Supprimer</button>
              </div>
            </div>
            <div class="history-meta" style="margin-top:10px;">${meta}</div>
          </div>
        `;
      }).join("");
    }

    document.addEventListener("input", (e) => {
      if (e.target && e.target.id === "historySearch") renderHistory();
    });

    document.addEventListener("click", async (e) => {
      const btn = e.target.closest("button[data-action]");
      if (!btn) return;

      const action = btn.getAttribute("data-action");
      const idx = Number(btn.getAttribute("data-idx"));
      const items = loadHistory();
      const item = items[idx];
      if (!item) return;

      if (action === "copy") {
        const ok = await copyText(item.code);
        if (ok) showSuccess(`‚úÖ <strong>Copi√© :</strong> ${item.code}`);
        else showError("‚ùå Impossible de copier automatiquement. Copie manuellement.");
      }

      if (action === "delete") {
        removeFromHistory(idx);
        showSuccess("‚úÖ Entr√©e supprim√©e de l'historique.");
      }

      if (action === "pin") {
        item.pinned = !item.pinned;
        items[idx] = item;
        items.sort((x, y) => (y.pinned === x.pinned) ? 0 : (y.pinned ? 1 : -1));
        saveHistory(items);
        renderHistory();
        renderStats();
        showSuccess(item.pinned ? "‚úÖ Entr√©e √©pingl√©e." : "‚úÖ Entr√©e d√©s√©pingl√©e.");
      }
    });

    document.getElementById("clearHistoryBtn").addEventListener("click", () => {
      clearHistory();
      showSuccess("‚úÖ Historique effac√©.");
    });

    document.getElementById("exportHistoryBtn").addEventListener("click", () => {
      const items = loadHistory();
      if (!items.length) return;

      const lines = items.map((it) => {
        return [
          it.createdAt,
          it.code,
          it.count && it.count > 1 ? `x${it.count}` : "",
          it.pinned ? "PINNED" : "",
          it.a !== undefined ? `A=${it.a} ${it.aLabel || ""}` : "",
          it.b !== undefined ? `B=${it.b} ${it.bLabel || ""}` : "",
          it.c !== undefined ? `C=${it.c} ${it.cLabel || ""}` : "",
          it.d !== undefined ? `D=${it.d} ${it.dLabel || ""}` : "",
          it.e !== undefined ? `E=${it.e} ${it.eLabel || ""}` : "",
          it.f !== undefined ? `F=${it.f} ${labelF(it.f)}` : "",
          it.montant !== undefined ? `Montant=${it.montant}` : "",
          it.pme !== undefined ? `PME=${it.pme ? "Oui" : "Non"}` : "",
          it.formRef ? `Ref=${it.formRef}` : "",
          it.formIntitule ? `Projet=${it.formIntitule}` : ""
        ].filter(Boolean).join(" | ");
      });

      const blob = new Blob([lines.join("\n")], { type: "text/plain;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "historique_codes_carnot.txt";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });

    // ---------- Import ----------
    const importBackdrop = document.getElementById("importBackdrop");
    const importText = document.getElementById("importText");

    function openImport() {
      importText.value = "";
      importBackdrop.style.display = "flex";
      importText.focus();
    }
    function closeImport() { importBackdrop.style.display = "none"; }

    document.getElementById("importBtn").addEventListener("click", openImport);
    document.getElementById("importCancel").addEventListener("click", closeImport);
    importBackdrop.addEventListener("click", (e) => {
      if (e.target === importBackdrop) closeImport();
    });

    function parseImportedLines(raw) {
      const lines = raw.split(/\r?\n/).map(l => l.trim()).filter(l => l.length > 0);
      return lines.map(l => {
        const m = l.match(/^(ct)\s*([0-9]{6})$/i) || l.match(/^(ct)\s*([0-9]{1,})$/i);
        return m ? `CT ${m[2]}` : l;
      });
    }

    document.getElementById("importConfirm").addEventListener("click", () => {
      const raw = importText.value || "";
      const codes = parseImportedLines(raw);

      if (!codes.length) {
        showError("‚ùå Rien √† importer.");
        return;
      }

      const now = formatDateISO(new Date());
      codes.forEach(code => addToHistory({ code, createdAt: now }));

      closeImport();
      showSuccess(`‚úÖ Import termin√© : ${codes.length} ligne(s) import√©e(s) (doublons regroup√©s).`);
    });

    // ---------- Print ----------
    function escapeHtml(s) {
      return (s || "").replace(/[&<>"']/g, (c) => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[c]));
    }

    function renderPrintBlock(entry) {
      const lines = [];
      lines.push(`<div style="font-size:18px; font-weight:900; color:#c4165a; font-family:Monaco, monospace;">${entry.code}</div>`);
      if (entry.formRef) lines.push(`<div style="margin-top:8px;"><strong>R√©f√©rence :</strong> ${escapeHtml(entry.formRef)}</div>`);
      if (entry.formIntitule) lines.push(`<div><strong>Projet :</strong> ${escapeHtml(entry.formIntitule)}</div>`);
      lines.push(`<div style="margin-top:8px; color:#333;"><strong>A‚ÄìF :</strong> ${entry.a ?? ""}${entry.b ?? ""}${entry.c ?? ""}${entry.d ?? ""}${entry.e ?? ""}${entry.f ?? ""}</div>`);
      if (entry.montant !== undefined) lines.push(`<div><strong>Montant :</strong> ${entry.montant} ‚Ç¨</div>`);
      if (entry.pme !== undefined) lines.push(`<div><strong>PME :</strong> ${entry.pme ? "Oui" : "Non"}</div>`);
      lines.push(`<div style="margin-top:10px; font-size:12px; color:#666;">${escapeHtml(entry.createdAt || "")}</div>`);
      return lines.join("");
    }

    document.getElementById("printBtn").addEventListener("click", () => {
      const items = loadHistory();
      const it = items[0];
      if (!it) {
        showError("‚ùå Rien √† imprimer. G√©n√®re un code d'abord.");
        return;
      }
      document.getElementById("printBlock").innerHTML = renderPrintBlock(it);
      document.getElementById("printDate").textContent = formatDateISO(new Date());
      window.print();
    });

    // ---------- ‚úÖ STATS (5) ----------
    function sumCounts(items) {
      return items.reduce((acc, it) => acc + (it.count && it.count > 0 ? it.count : 1), 0);
    }
    function topN(map, n=3) {
      return Object.entries(map).sort((a,b) => b[1]-a[1]).slice(0,n);
    }
    function fmtPct(part, total) {
      if (!total) return "0%";
      return `${Math.round((part / total) * 100)}%`;
    }

    function renderStats() {
      const box = document.getElementById("statsBox");
      const content = document.getElementById("statsContent");
      const items = loadHistory();

      if (!items.length) {
        box.style.display = "none";
        content.innerHTML = "";
        return;
      }

      const totalEvents = sumCounts(items);   // pond√©r√© (count)
      const distinctCodes = items.length;
      const pinned = items.filter(i => i.pinned).length;

      let pmeYes = 0, pmeNo = 0;
      const fDist = {};      // F -> count
      const abcDist = {};    // "A-B-C" -> count
      const amountDist = { neg:0, zero:0, lt15:0, mid:0, gt30:0, unknown:0 };

      items.forEach(it => {
        const w = (it.count && it.count > 0) ? it.count : 1;

        if (it.pme === true) pmeYes += w;
        else if (it.pme === false) pmeNo += w;

        if (it.f !== undefined && it.f !== null && it.f !== "") {
          fDist[it.f] = (fDist[it.f] || 0) + w;
        }

        if (it.a !== undefined && it.b !== undefined && it.c !== undefined) {
          const k = `${it.a}-${it.b}-${it.c}`;
          abcDist[k] = (abcDist[k] || 0) + w;
        }

        const m = (it.montant !== undefined && it.montant !== null) ? Number(it.montant) : NaN;
        if (!Number.isFinite(m)) { amountDist.unknown += w; return; }
        if (m < 0) amountDist.neg += w;
        else if (m === 0) amountDist.zero += w;
        else if (m < 15000) amountDist.lt15 += w;
        else if (m <= 30000) amountDist.mid += w;
        else amountDist.gt30 += w;
      });

      const topABC = topN(abcDist, 3);
      const topF = topN(fDist, 6);

      const lines = [];

      lines.push(`<div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px;">
        <span style="padding:6px 10px; border:1px solid #e0e0e0; border-radius:999px; font-weight:900;">Total g√©n√©rations/imports : ${totalEvents}</span>
        <span style="padding:6px 10px; border:1px solid #e0e0e0; border-radius:999px; font-weight:900;">Codes distincts : ${distinctCodes}</span>
        <span style="padding:6px 10px; border:1px solid #e0e0e0; border-radius:999px; font-weight:900;">√âpingl√©s : ${pinned}</span>
      </div>`);

      lines.push(`<div style="margin-top:6px;">
        <strong>PME :</strong>
        Oui ${pmeYes} (${fmtPct(pmeYes, totalEvents)}) ‚Ä¢
        Non ${pmeNo} (${fmtPct(pmeNo, totalEvents)})
      </div>`);

      lines.push(`<div style="margin-top:10px;">
        <strong>R√©partition par F :</strong><br/>
        ${topF.length ? topF.map(([k,v]) => `F=${k} : ${v} (${fmtPct(v, totalEvents)})`).join(" ‚Ä¢ ") : "‚Äî"}
      </div>`);

      lines.push(`<div style="margin-top:10px;">
        <strong>Top 3 combinaisons A-B-C :</strong><br/>
        ${topABC.length ? topABC.map(([k,v]) => `${k} : ${v} (${fmtPct(v, totalEvents)})`).join("<br/>") : "‚Äî"}
      </div>`);

      lines.push(`<div style="margin-top:10px;">
        <strong>Montants (classes) :</strong><br/>
        <span>‚üÇ &lt;0 : ${amountDist.neg} (${fmtPct(amountDist.neg, totalEvents)})</span> ‚Ä¢
        <span>0 : ${amountDist.zero} (${fmtPct(amountDist.zero, totalEvents)})</span> ‚Ä¢
        <span>&lt;15k : ${amountDist.lt15} (${fmtPct(amountDist.lt15, totalEvents)})</span><br/>
        <span>15‚Äì30k : ${amountDist.mid} (${fmtPct(amountDist.mid, totalEvents)})</span> ‚Ä¢
        <span>&gt;30k : ${amountDist.gt30} (${fmtPct(amountDist.gt30, totalEvents)})</span> ‚Ä¢
        <span>Inconnu : ${amountDist.unknown} (${fmtPct(amountDist.unknown, totalEvents)})</span>
      </div>`);

      box.style.display = "block";
      content.innerHTML = lines.join("");
    }

    document.getElementById("refreshStatsBtn").addEventListener("click", () => {
      renderStats();
      showSuccess("‚úÖ Statistiques rafra√Æchies.");
    });

    // ---------- Generate ----------
    document.getElementById("carnotForm").addEventListener("submit", (event) => {
      event.preventDefault();

      const a = getSelectValue('formA');
      const b = getSelectValue('formB');
      const c = getSelectValue('formC');
      const d = getSelectValue('formD');
      const eVal = getSelectValue('formE');

      if (!a || !b || !c || !d || !eVal) {
        showError("‚ùå Merci de s√©lectionner A, B, C, D et E.");
        return;
      }

      const rawMontant = document.getElementById('formMontant').value;
      const montant = Number(rawMontant);
      const pme = document.getElementById('formPME').checked;
      const f = calculateF(montant, pme);

      const code = `CT ${a}${b}${c}${d}${eVal}${f}`;

      document.getElementById('generatedCode').textContent = code;
      document.getElementById('codeBox').style.display = 'block';
      showSuccess(`‚úÖ <strong>Code g√©n√©r√© :</strong> <strong>${code}</strong>`);

      const aLabel = getSelectLabel("formA");
      const bLabel = getSelectLabel("formB");
      const cLabel = getSelectLabel("formC");
      const dLabel = getSelectLabel("formD");
      const eLabel = getSelectLabel("formE");

      document.getElementById("decompList").innerHTML = `
        <div><span class="pill">A=${a}</span> ${aLabel}</div>
        <div><span class="pill">B=${b}</span> ${bLabel}</div>
        <div><span class="pill">C=${c}</span> ${cLabel}</div>
        <div><span class="pill">D=${d}</span> ${dLabel}</div>
        <div><span class="pill">E=${eVal}</span> ${eLabel}</div>
        <div><span class="pill">F=${f}</span> ${labelF(f)} (montant=${Number.isNaN(montant) ? 0 : montant}, PME=${pme ? "Oui" : "Non"})</div>
      `;
      document.getElementById("decompBox").style.display = "block";

      addToHistory({
        code,
        createdAt: formatDateISO(new Date()),
        formRef: (document.getElementById("formRef").value || "").trim(),
        formIntitule: (document.getElementById("formIntitule").value || "").trim(),
        montant: Number.isNaN(montant) ? 0 : montant,
        pme,
        a, b, c, d,
        e: eVal,
        f,
        aLabel, bLabel, cLabel, dLabel, eLabel
      });
    });

    document.getElementById('copyBtn').addEventListener('click', async () => {
      const code = document.getElementById('generatedCode').textContent.trim();
      if (!code) return;

      const ok = await copyText(code);
      if (ok) showSuccess(`‚úÖ <strong>Copi√© :</strong> ${code}`);
      else showError("‚ùå Impossible de copier automatiquement. S√©lectionne le code et copie-le manuellement.");
    });

    document.getElementById('newBtn').addEventListener('click', () => {
      document.getElementById('carnotForm').reset();
      document.getElementById('codeBox').style.display = 'none';
      document.getElementById('formError').style.display = 'none';
      document.getElementById('formSuccess').style.display = 'none';

      ['formA', 'formB', 'formC', 'formD', 'formE'].forEach(id => {
        const s = document.getElementById(id);
        if (s) s.selectedIndex = 0;
      });
    });

    // init
    renderHistory();
    renderStats();
  </script>
</body>
</html>
```
